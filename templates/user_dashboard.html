<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <title>Randevu Al</title>

    <style>
      .slot-taken {
        background-color: red !important;
        border-color: red !important;
        color: white !important;
        cursor: not-allowed !important;
      }
      
      .slot-available {
        background-color: transparent;
        border-color: #198754;
        color: #198754;
        transition: all 0.2s ease;
      }
      
      .slot-available:hover {
        background-color: #198754;
        color: white;
      }
      
      .slot-available.active {
        background-color: #198754 !important;
        color: white !important;
        border-color: #198754 !important;
      }
      
      /* Bootstrap'ın varsayılan active stilini override et */
      .btn-outline-success.active {
        background-color: #198754 !important;
        color: white !important;
        border-color: #198754 !important;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div class="d-flex justify-content-end mb-3">
        <a href="/logout" class="btn btn-outline-success">Çıkış Yap</a>
      </div>

      <div class="card shadow p-4">
        <h3 class="mb-4">Randevu Al</h3>
        
        {% if error_message %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
          {{ error_message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <form method="POST">
          <div class="mb-3">
            <label class="form-label">Hizmet:</label>
            <input
              type="text"
              name="service"
              class="form-control"
              placeholder="Saç, Sakal, Makyaj..."
              required
            />
          </div>
          
          <div class="mb-3">
            <label class="form-label">Tarih:</label>
            <input 
              type="date" 
              name="date" 
              id="date" 
              class="form-control form-control-lg" 
              required 
              min="{{ today }}"
              value="{{ selected_date }}"
              onchange="updateSlots()"
            >
          </div>
          
          <div class="mb-3">
            <label class="form-label">Saat Seçimi:</label>
            <div class="d-flex flex-wrap gap-2" id="timeSlots">
              {% for slot in slots %}
                {% if slot in taken %}
                  <button 
                    type="button" 
                    class="btn btn-sm slot-taken" 
                    disabled
                    title="Bu saat dolu"
                  >
                    {{ slot }}
                  </button>
                {% else %}
                  <button 
                    type="button" 
                    class="btn btn-sm slot-available"
                    onclick="selectSlot('{{ slot }}', this)"
                    title="Bu saat müsait"
                  >
                    {{ slot }}
                  </button>
                {% endif %}
              {% endfor %}
            </div>
            <input type="hidden" name="time" id="selectedTime" required>
            <div class="form-text">⏰Lütfen bir saat seçin</div>
          </div>

          <button type="submit" class="btn btn-success w-100">
            Randevu Gönder
          </button>
        </form>
      </div>

      <div class="mt-5">
        <h4>Randevularım</h4>
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead class="table-dark">
              <tr>
                <th>Hizmet</th>
                <th>Tarih</th>
                <th>Saat</th>
                <th>Durum</th>
                <th>İşlem</th>
              </tr>
            </thead>
            <tbody>
              {% for r in appointments %}
              <tr>
                <td>{{ r.service }}</td>
                <td>{{ r.date }}</td>
                <td>{{ r.time }}</td>
                <td>
                  {% if r.status == 'pending' %}
                    <span class="badge bg-warning">Beklemede</span>
                  {% elif r.status == 'approved' %}
                    <span class="badge bg-success">Onaylandı</span>
                  {% elif r.status == 'rejected' %}
                    <span class="badge bg-danger">Reddedildi</span>
                  {% elif r.status == 'cancelled' %}
                    <span class="badge bg-secondary">İptal Edildi</span>
                  {% else %}
                    <span class="badge bg-light text-dark">Bilinmiyor</span>
                  {% endif %}
                </td>
                <td>
                  {% if r.status in ['pending', 'approved'] %}
                    <a
                      href="/cancel/{{ r.id }}"
                      class="btn btn-sm btn-outline-danger"
                      onclick="return confirm('Randevuyu iptal etmek istediğinizden emin misiniz?')"
                    >
                      İptal Et
                    </a>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function selectSlot(time, btn) {
        // Seçilen saati hidden input'a yaz
        document.getElementById("selectedTime").value = time;

        // Tüm aktif saat butonlarından active class'ını kaldır
        document.querySelectorAll('.slot-available').forEach(b => {
          b.classList.remove('active');
        });

        // Seçilen butona active class'ını ekle
        btn.classList.add('active');
      }

      function updateSlots() {
        const selectedDate = document.getElementById('date').value;
        if (selectedDate) {
          // Tarih değiştiğinde sayfayı yenile ki yeni tarih için slot'ları görelim
          window.location.href = `/dashboard?date=${selectedDate}`;
        }
      }

      // Sayfa yüklendiğinde form validation'ı ekle
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
          const selectedTime = document.getElementById('selectedTime').value;
          if (!selectedTime) {
            e.preventDefault();
            alert('Lütfen bir saat seçin!');
          }
        });
      });
    </script>
  </body>
</html>